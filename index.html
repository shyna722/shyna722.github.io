<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Card Crusade - A Balatro-inspired Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 配置Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6d28d9', // 主紫色
            secondary: '#ec4899', // 辅助粉色
            accent: '#f59e0b', // 强调色-金色
            dark: '#1e1b4b', // 深色背景
            light: '#f3e8ff', // 浅色文本
          },
          fontFamily: {
            game: ['"Press Start 2P"', 'cursive', 'sans-serif'],
            body: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .card-shadow {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      }
      .card-hover {
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
      }
      .animate-deal {
        animation: dealCard 0.5s ease-out forwards;
      }
      .animate-draw {
        animation: drawCard 0.3s ease-out forwards;
      }
      .animate-shine {
        animation: shine 1.5s ease-in-out infinite;
      }
    }
    
    @keyframes dealCard {
      0% { transform: translateY(-50px) rotate(-10deg); opacity: 0; }
      100% { transform: translateY(0) rotate(0); opacity: 1; }
    }
    
    @keyframes drawCard {
      0% { transform: scale(0.8) rotate(5deg); opacity: 0; }
      100% { transform: scale(1) rotate(0); opacity: 1; }
    }
    
    @keyframes shine {
      0%, 100% { box-shadow: 0 0 10px rgba(245, 158, 11, 0.6); }
      50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.9); }
    }
  </style>
  
  <!-- 引入字体 -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gradient-to-br from-dark to-primary min-h-screen text-light font-body overflow-x-hidden">
  <!-- 游戏容器 -->
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- 游戏标题 -->
    <header class="text-center mb-8">
      <h1 class="text-[clamp(2rem,5vw,3.5rem)] font-game text-accent mb-2 tracking-wider">CARD CRUSADE</h1>
      <p class="text-light/70 text-lg">Build the best hand, score big, conquer the deck!</p>
    </header>
    
    <!-- 游戏状态栏 -->
    <div class="flex flex-wrap justify-between items-center mb-6 gap-4 p-4 bg-dark/50 rounded-lg border border-light/10">
      <div class="flex items-center gap-6">
        <div>
          <p class="text-sm text-light/60">Score</p>
          <p class="text-2xl font-bold text-accent" id="score">0</p>
        </div>
        <div>
          <p class="text-sm text-light/60">Round</p>
          <p class="text-2xl font-bold text-accent" id="round">1</p>
        </div>
        <div>
          <p class="text-sm text-light/60">Cards Left</p>
          <p class="text-2xl font-bold text-accent" id="cards-left">40</p>
        </div>
      </div>
      
      <div class="flex gap-3">
        <button id="help-btn" class="px-4 py-2 bg-light/10 hover:bg-light/20 rounded-lg transition-all flex items-center gap-2">
          <i class="fa fa-question-circle"></i>
          <span>Help</span>
        </button>
        <button id="restart-btn" class="px-4 py-2 bg-accent hover:bg-accent/80 rounded-lg transition-all flex items-center gap-2">
          <i class="fa fa-refresh"></i>
          <span>Restart</span>
        </button>
      </div>
    </div>
    
    <!-- 游戏区域 -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- 左侧：信息面板 -->
      <div class="lg:col-span-1 flex flex-col gap-6">
        <!-- 组合信息 -->
        <div class="bg-dark/50 rounded-lg border border-light/10 p-5">
          <h2 class="text-xl font-bold mb-4 text-secondary">Current Hand</h2>
          <div id="hand-info" class="space-y-2">
            <p class="text-light/70">No cards selected</p>
          </div>
        </div>
        
        <!-- 可能的组合 -->
        <div class="bg-dark/50 rounded-lg border border-light/10 p-5">
          <h2 class="text-xl font-bold mb-4 text-secondary">Possible Combos</h2>
          <div id="possible-combos" class="space-y-2 max-h-60 overflow-y-auto pr-2">
            <div class="p-2 bg-light/5 rounded border border-light/10">
              <p class="font-bold">Pair</p>
              <p class="text-sm text-light/70">Two cards of the same rank - 100 points</p>
            </div>
            <div class="p-2 bg-light/5 rounded border border-light/10">
              <p class="font-bold">Three of a Kind</p>
              <p class="text-sm text-light/70">Three cards of the same rank - 300 points</p>
            </div>
            <div class="p-2 bg-light/5 rounded border border-light/10">
              <p class="font-bold">Straight</p>
              <p class="text-sm text-light/70">Five consecutive ranks - 500 points</p>
            </div>
            <div class="p-2 bg-light/5 rounded border border-light/10">
              <p class="font-bold">Flush</p>
              <p class="text-sm text-light/70">All cards same suit - 600 points</p>
            </div>
            <div class="p-2 bg-light/5 rounded border border-light/10">
              <p class="font-bold">Straight Flush</p>
              <p class="text-sm text-light/70">Consecutive ranks, same suit - 1000 points</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 中间：主游戏区 -->
      <div class="lg:col-span-2 flex flex-col gap-6">
        <!-- 出牌区 -->
        <div class="bg-dark/50 rounded-lg border border-light/10 p-5 min-h-[180px]">
          <h2 class="text-xl font-bold mb-4 text-secondary">Play Area</h2>
          <div id="play-area" class="flex flex-wrap gap-3 justify-center">
            <p class="text-light/50 italic">Drag cards here to form your hand</p>
          </div>
        </div>
        
        <!-- 手牌区 -->
        <div class="bg-dark/50 rounded-lg border border-light/10 p-5">
          <h2 class="text-xl font-bold mb-4 text-secondary">Your Cards</h2>
          <div id="hand-area" class="flex flex-wrap gap-3 justify-center">
            <!-- 卡牌将通过JS动态生成 -->
          </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="flex justify-center gap-4">
          <button id="draw-btn" class="px-6 py-3 bg-accent hover:bg-accent/80 rounded-lg transition-all font-bold text-lg animate-shine">
            Draw Cards
          </button>
          <button id="score-btn" class="px-6 py-3 bg-secondary hover:bg-secondary/80 rounded-lg transition-all font-bold text-lg" disabled>
            Score Hand
          </button>
        </div>
      </div>
    </div>
    
    <!-- 游戏结束模态框 -->
    <div id="game-over-modal" class="fixed inset-0 bg-dark/80 flex items-center justify-center z-50 hidden">
      <div class="bg-dark border-2 border-accent rounded-lg p-8 max-w-md w-full mx-4 text-center">
        <h2 class="text-3xl font-game text-accent mb-4">GAME OVER</h2>
        <p class="text-xl mb-2">Your Final Score</p>
        <p class="text-4xl font-bold text-light mb-6" id="final-score">0</p>
        <button id="play-again-btn" class="px-6 py-3 bg-accent hover:bg-accent/80 rounded-lg transition-all font-bold text-lg w-full">
          Play Again
        </button>
      </div>
    </div>
    
    <!-- 帮助模态框 -->
    <div id="help-modal" class="fixed inset-0 bg-dark/80 flex items-center justify-center z-50 hidden">
      <div class="bg-dark border-2 border-accent rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
        <h2 class="text-2xl font-game text-accent mb-4">How to Play</h2>
        <div class="space-y-4 text-light/90">
          <p>1. Click "Draw Cards" to get 5 cards from the deck</p>
          <p>2. Drag cards from your hand to the play area to form your hand</p>
          <p>3. Create card combos to score points</p>
          <p>4. Click "Score Hand" to calculate your points and start a new round</p>
          <p>5. The game ends when the deck runs out of cards</p>
          
          <h3 class="text-xl text-secondary mt-6 mb-2">Combo Values</h3>
          <ul class="list-disc pl-5 space-y-1">
            <li>Pair - 100 points</li>
            <li>Two Pairs - 250 points</li>
            <li>Three of a Kind - 300 points</li>
            <li>Straight - 500 points</li>
            <li>Flush - 600 points</li>
            <li>Full House - 800 points</li>
            <li>Four of a Kind - 900 points</li>
            <li>Straight Flush - 1000 points</li>
            <li>Royal Flush - 2000 points</li>
          </ul>
        </div>
        <button id="close-help-btn" class="mt-6 px-6 py-2 bg-accent hover:bg-accent/80 rounded-lg transition-all font-bold">
          Close
        </button>
      </div>
    </div>
  </div>

  <script>
    // 游戏状态
    const gameState = {
      deck: [],
      hand: [],
      playArea: [],
      score: 0,
      round: 1,
      cardsLeft: 52,
      gameOver: false
    };
    
    // 卡牌配置
    const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
    const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
    const rankValues = {
      '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10,
      'J': 11, 'Q': 12, 'K': 13, 'A': 14
    };
    
    // DOM元素
    const handArea = document.getElementById('hand-area');
    const playArea = document.getElementById('play-area');
    const scoreDisplay = document.getElementById('score');
    const roundDisplay = document.getElementById('round');
    const cardsLeftDisplay = document.getElementById('cards-left');
    const drawBtn = document.getElementById('draw-btn');
    const scoreBtn = document.getElementById('score-btn');
    const restartBtn = document.getElementById('restart-btn');
    const handInfo = document.getElementById('hand-info');
    const gameOverModal = document.getElementById('game-over-modal');
    const finalScoreDisplay = document.getElementById('final-score');
    const playAgainBtn = document.getElementById('play-again-btn');
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('help-modal');
    const closeHelpBtn = document.getElementById('close-help-btn');
    
    // 初始化游戏
    function initGame() {
      // 重置游戏状态
      gameState.deck = createDeck();
      gameState.hand = [];
      gameState.playArea = [];
      gameState.score = 0;
      gameState.round = 1;
      gameState.cardsLeft = 52;
      gameState.gameOver = false;
      
      // 更新UI
      updateScore();
      updateRound();
      updateCardsLeft();
      renderHand();
      renderPlayArea();
      updateHandInfo();
      
      // 禁用按钮
      scoreBtn.disabled = true;
      gameOverModal.classList.add('hidden');
    }
    
    // 创建一副新牌
    function createDeck() {
      const deck = [];
      for (const suit of suits) {
        for (const rank of ranks) {
          deck.push({
            id: `${suit}-${rank}`,
            suit,
            rank,
            value: rankValues[rank]
          });
        }
      }
      // 洗牌
      return shuffleDeck(deck);
    }
    
    // 洗牌算法
    function shuffleDeck(deck) {
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      return deck;
    }
    
    // 抽牌
    function drawCards(count = 5) {
      if (gameState.deck.length < count) {
        endGame();
        return;
      }
      
      // 清空当前手牌和出牌区
      gameState.hand = [];
      gameState.playArea = [];
      
      // 抽牌
      for (let i = 0; i < count; i++) {
        const card = gameState.deck.pop();
        gameState.hand.push(card);
        gameState.cardsLeft--;
      }
      
      // 更新UI
      renderHand();
      renderPlayArea();
      updateCardsLeft();
      updateHandInfo();
      
      // 禁用抽牌按钮，启用计分按钮
      drawBtn.disabled = true;
      scoreBtn.disabled = false;
    }
    
    // 计算手牌分数
    function calculateScore() {
      if (gameState.playArea.length === 0) return 0;
      
      // 分析手牌
      const combo = analyzeHand(gameState.playArea);
      updateHandInfo(combo);
      
      // 添加分数
      gameState.score += combo.score;
      updateScore();
      
      // 进入下一轮
      gameState.round++;
      updateRound();
      
      // 重新启用抽牌按钮，禁用计分按钮
      drawBtn.disabled = false;
      scoreBtn.disabled = true;
      
      return combo.score;
    }
    
    // 分析手牌组合
    function analyzeHand(hand) {
      if (hand.length < 2) {
        return { type: 'No Combo', score: 0 };
      }
      
      // 按点数排序
      const sortedHand = [...hand].sort((a, b) => a.value - b.value);
      
      // 检查同花大顺
      if (isRoyalFlush(sortedHand)) {
        return { type: 'Royal Flush', score: 2000 };
      }
      
      // 检查同花顺
      if (isStraightFlush(sortedHand)) {
        return { type: 'Straight Flush', score: 1000 };
      }
      
      // 检查四条
      if (isFourOfAKind(sortedHand)) {
        return { type: 'Four of a Kind', score: 900 };
      }
      
      // 检查葫芦
      if (isFullHouse(sortedHand)) {
        return { type: 'Full House', score: 800 };
      }
      
      // 检查同花
      if (isFlush(sortedHand)) {
        return { type: 'Flush', score: 600 };
      }
      
      // 检查顺子
      if (isStraight(sortedHand)) {
        return { type: 'Straight', score: 500 };
      }
      
      // 检查三条
      if (isThreeOfAKind(sortedHand)) {
        return { type: 'Three of a Kind', score: 300 };
      }
      
      // 检查两对
      if (isTwoPairs(sortedHand)) {
        return { type: 'Two Pairs', score: 250 };
      }
      
      // 检查一对
      if (isPair(sortedHand)) {
        return { type: 'Pair', score: 100 };
      }
      
      return { type: 'High Card', score: 0 };
    }
    
    // 组合检查函数
    function isRoyalFlush(hand) {
      if (hand.length !== 5) return false;
      if (!isFlush(hand)) return false;
      
      const ranks = hand.map(card => card.rank);
      return ranks.includes('10') && ranks.includes('J') && 
             ranks.includes('Q') && ranks.includes('K') && ranks.includes('A');
    }
    
    function isStraightFlush(hand) {
      return hand.length === 5 && isStraight(hand) && isFlush(hand);
    }
    
    function isFourOfAKind(hand) {
      const rankCounts = getRankCounts(hand);
      return Object.values(rankCounts).includes(4);
    }
    
    function isFullHouse(hand) {
      const rankCounts = getRankCounts(hand);
      const counts = Object.values(rankCounts);
      return counts.includes(3) && counts.includes(2);
    }
    
    function isFlush(hand) {
      const suit = hand[0].suit;
      return hand.every(card => card.suit === suit);
    }
    
    function isStraight(hand) {
      if (hand.length !== 5) return false;
      
      // 检查A-2-3-4-5的特殊情况
      const isLowStraight = hand[0].value === 2 && hand[1].value === 3 && 
                           hand[2].value === 4 && hand[3].value === 5 && 
                           hand[4].value === 14; // Ace
      if (isLowStraight) return true;
      
      // 检查正常顺子
      for (let i = 0; i < hand.length - 1; i++) {
        if (hand[i + 1].value - hand[i].value !== 1) {
          return false;
        }
      }
      return true;
    }
    
    function isThreeOfAKind(hand) {
      const rankCounts = getRankCounts(hand);
      return Object.values(rankCounts).includes(3);
    }
    
    function isTwoPairs(hand) {
      const rankCounts = getRankCounts(hand);
      const pairs = Object.values(rankCounts).filter(count => count === 2);
      return pairs.length === 2;
    }
    
    function isPair(hand) {
      const rankCounts = getRankCounts(hand);
      return Object.values(rankCounts).includes(2);
    }
    
    // 获取每个点数的出现次数
    function getRankCounts(hand) {
      const counts = {};
      for (const card of hand) {
        counts[card.rank] = (counts[card.rank] || 0) + 1;
      }
      return counts;
    }
    
    // 渲染手牌
    function renderHand() {
      handArea.innerHTML = '';
      
      if (gameState.hand.length === 0) {
        handArea.innerHTML = '<p class="text-light/50 italic">Click "Draw Cards" to get your cards</p>';
        return;
      }
      
      for (const card of gameState.hand) {
        const cardElement = createCardElement(card, true);
        handArea.appendChild(cardElement);
      }
    }
    
    // 渲染出牌区
    function renderPlayArea() {
      playArea.innerHTML = '';
      
      if (gameState.playArea.length === 0) {
        playArea.innerHTML = '<p class="text-light/50 italic">Drag cards here to form your hand</p>';
        return;
      }
      
      for (const card of gameState.playArea) {
        const cardElement = createCardElement(card, false);
        playArea.appendChild(cardElement);
      }
    }
    
    // 创建卡牌元素
    function createCardElement(card, isInHand) {
      const cardElement = document.createElement('div');
      cardElement.className = `w-20 h-30 rounded-lg card-shadow card-hover animate-deal cursor-move relative`;
      
      // 根据花色设置颜色
      const isRed = card.suit === 'hearts' || card.suit === 'diamonds';
      cardElement.classList.add(isRed ? 'bg-red-100' : 'bg-gray-100');
      cardElement.classList.add(isRed ? 'text-red-600' : 'text-gray-800');
      
      // 设置卡牌内容
      cardElement.innerHTML = `
        <div class="absolute top-2 left-2 text-lg font-bold">${card.rank}</div>
        <div class="absolute top-2 right-2 text-xl">${getSuitSymbol(card.suit)}</div>
        <div class="absolute bottom-2 right-2 text-lg font-bold transform rotate-180">${card.rank}</div>
        <div class="absolute bottom-2 left-2 text-xl transform rotate-180">${getSuitSymbol(card.suit)}</div>
      `;
      
      // 设置拖拽功能
      cardElement.setAttribute('draggable', 'true');
      cardElement.dataset.cardId = card.id;
      
      cardElement.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', card.id);
        e.dataTransfer.effectAllowed = 'move';
      });
      
      // 如果卡牌在出牌区，添加点击移除功能
      if (!isInHand) {
        cardElement.addEventListener('click', () => {
          removeFromPlayArea(card.id);
        });
      }
      
      return cardElement;
    }
    
    // 获取花色符号
    function getSuitSymbol(suit) {
      switch(suit) {
        case 'hearts': return '♥';
        case 'diamonds': return '♦';
        case 'clubs': return '♣';
        case 'spades': return '♠';
        default: return '';
      }
    }
    
    // 添加到出牌区
    function addToPlayArea(cardId) {
      // 从手牌中找到卡牌
      const cardIndex = gameState.hand.findIndex(card => card.id === cardId);
      if (cardIndex === -1) return;
      
      const card = gameState.hand.splice(cardIndex, 1)[0];
      
      // 添加到出牌区
      gameState.playArea.push(card);
      
      // 更新UI
      renderHand();
      renderPlayArea();
      updateHandInfo();
      
      // 如果出牌区有卡牌，启用计分按钮
      scoreBtn.disabled = gameState.playArea.length === 0;
    }
    
    // 从出牌区移除
    function removeFromPlayArea(cardId) {
      // 从出牌区找到卡牌
      const cardIndex = gameState.playArea.findIndex(card => card.id === cardId);
      if (cardIndex === -1) return;
      
      const card = gameState.playArea.splice(cardIndex, 1)[0];
      
      // 添加到手牌
      gameState.hand.push(card);
      
      // 更新UI
      renderHand();
      renderPlayArea();
      updateHandInfo();
      
      // 如果出牌区没有卡牌，禁用计分按钮
      if (gameState.playArea.length === 0) {
        scoreBtn.disabled = true;
      }
    }
    
    // 更新手牌信息
    function updateHandInfo(combo = null) {
      handInfo.innerHTML = '';
      
      if (gameState.playArea.length === 0) {
        handInfo.innerHTML = '<p class="text-light/70">No cards selected</p>';
        return;
      }
      
      // 显示选中的卡牌
      const cardsList = document.createElement('div');
      cardsList.className = 'mb-3';
      cardsList.innerHTML = `<p class="font-bold">Selected Cards: ${gameState.playArea.length}</p>`;
      handInfo.appendChild(cardsList);
      
      // 显示组合信息
      if (combo) {
        const comboInfo = document.createElement('div');
        comboInfo.className = 'p-2 bg-accent/20 rounded border border-accent/30';
        comboInfo.innerHTML = `
          <p class="font-bold text-accent">${combo.type}</p>
          <p class="text-light/80">+${combo.score} points</p>
        `;
        handInfo.appendChild(comboInfo);
      } else {
        const currentCombo = analyzeHand(gameState.playArea);
        if (currentCombo.score > 0) {
          const comboInfo = document.createElement('div');
          comboInfo.className = 'p-2 bg-light/5 rounded border border-light/10';
          comboInfo.innerHTML = `
            <p class="font-bold">${currentCombo.type}</p>
            <p class="text-light/70">${currentCombo.score} points</p>
          `;
          handInfo.appendChild(comboInfo);
        } else {
          handInfo.innerHTML += '<p class="text-light/70">No valid combo</p>';
        }
      }
    }
    
    // 更新分数显示
    function updateScore() {
      scoreDisplay.textContent = gameState.score;
      finalScoreDisplay.textContent = gameState.score;
    }
    
    // 更新回合显示
    function updateRound() {
      roundDisplay.textContent = gameState.round;
    }
    
    // 更新剩余卡牌显示
    function updateCardsLeft() {
      cardsLeftDisplay.textContent = gameState.cardsLeft;
    }
    
    // 结束游戏
    function endGame() {
      gameState.gameOver = true;
      gameOverModal.classList.remove('hidden');
    }
    
    // 事件监听
    drawBtn.addEventListener('click', () => {
      drawCards();
    });
    
    scoreBtn.addEventListener('click', () => {
      calculateScore();
    });
    
    restartBtn.addEventListener('click', initGame);
    playAgainBtn.addEventListener('click', initGame);
    
    // 帮助模态框
    helpBtn.addEventListener('click', () => {
      helpModal.classList.remove('hidden');
    });
    
    closeHelpBtn.addEventListener('click', () => {
      helpModal.classList.add('hidden');
    });
    
    // 出牌区拖拽目标
    playArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    });
    
    playArea.addEventListener('drop', (e) => {
      e.preventDefault();
      const cardId = e.dataTransfer.getData('text/plain');
      addToPlayArea(cardId);
    });
    
    // 手牌区拖拽目标
    handArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    });
    
    handArea.addEventListener('drop', (e) => {
      e.preventDefault();
      const cardId = e.dataTransfer.getData('text/plain');
      removeFromPlayArea(cardId);
    });
    
    // 初始化游戏
    window.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>

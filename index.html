<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>卡牌征程</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 配置Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6d28d9', // 主紫色
            secondary: '#ec4899', // 辅助粉色
            accent: '#f59e0b', // 强调色-金色
            dark: '#1e1b4b', // 深色背景
            light: '#f3e8ff', // 浅色文本
          },
          fontFamily: {
            game: ['"Press Start 2P"', 'cursive', 'sans-serif'],
            body: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .card-shadow {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      }
      .card-hover {
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
      }
      .animate-deal {
        animation: dealCard 0.5s ease-out forwards;
      }
      .animate-draw {
        animation: drawCard 0.3s ease-out forwards;
      }
      .animate-shine {
        animation: shine 1.5s ease-in-out infinite;
      }
      .drag-over {
        background-color: rgba(245, 158, 11, 0.1);
        border-color: rgba(245, 158, 11, 0.5);
      }
      .item-hover {
        transition: all 0.2s;
      }
      .item-hover:hover {
        transform: scale(1.03);
        background-color: rgba(245, 158, 11, 0.1);
      }
    }
    
    @keyframes dealCard {
      0% { transform: translateY(-50px) rotate(-10deg); opacity: 0; }
      100% { transform: translateY(0) rotate(0); opacity: 1; }
    }
    
    @keyframes drawCard {
      0% { transform: scale(0.8) rotate(5deg); opacity: 0; }
      100% { transform: scale(1) rotate(0); opacity: 1; }
    }
    
    @keyframes shine {
      0%, 100% { box-shadow: 0 0 10px rgba(245, 158, 11, 0.6); }
      50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.9); }
    }
  </style>
  
  <!-- 引入字体 -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gradient-to-br from-dark to-primary min-h-screen text-light font-body overflow-x-hidden">
  <!-- 游戏容器 -->
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- 游戏标题 -->
    <header class="text-center mb-8">
      <h1 class="text-[clamp(2rem,5vw,3.5rem)] font-game text-accent mb-2 tracking-wider">卡牌征程</h1>
      <p class="text-light/70 text-lg">组合最佳手牌，获取高分，征服牌堆！</p>
    </header>
    
    <!-- 游戏状态栏 -->
    <div class="flex flex-wrap justify-between items-center mb-6 gap-4 p-4 bg-dark/50 rounded-lg border border-light/10">
      <div class="flex items-center gap-6">
        <div>
          <p class="text-sm text-light/60">分数</p>
          <p class="text-2xl font-bold text-accent" id="score">0</p>
        </div>
        <div>
          <p class="text-sm text-light/60">回合</p>
          <p class="text-2xl font-bold text-accent" id="round">1</p>
        </div>
        <div>
          <p class="text-sm text-light/60">剩余牌数</p>
          <p class="text-2xl font-bold text-accent" id="cards-left">52</p>
        </div>
      </div>
      
      <div class="flex gap-3">
        <button id="help-btn" class="px-4 py-2 bg-light/10 hover:bg-light/20 rounded-lg transition-all flex items-center gap-2">
          <i class="fa fa-question-circle"></i>
          <span>帮助</span>
        </button>
        <button id="restart-btn" class="px-4 py-2 bg-accent hover:bg-accent/80 rounded-lg transition-all flex items-center gap-2">
          <i class="fa fa-refresh"></i>
          <span>重新开始</span>
        </button>
      </div>
    </div>
    
    <!-- 游戏区域 -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- 左侧：信息面板 -->
      <div class="lg:col-span-1 flex flex-col gap-6">
        <!-- 组合信息 -->
        <div class="bg-dark/50 rounded-lg border border-light/10 p-5">
          <h2 class="text-xl font-bold mb-4 text-secondary">当前手牌</h2>
          <div id="hand-info" class="space-y-2">
            <p class="text-light/70">未选择卡牌</p>
          </div>
        </div>
        
        <!-- 可能的组合 -->
        <div class="bg-dark/50 rounded-lg border border-light/10 p-5">
          <h2 class="text-xl font-bold mb-4 text-secondary">可能的组合</h2>
          <div id="possible-combos" class="space-y-2 max-h-60 overflow-y-auto pr-2">
            <div class="p-2 bg-light/5 rounded border border-light/10">
              <p class="font-bold">一对</p>
              <p class="text-sm text-light/70">两张相同点数的牌 - 100分</p>
            </div>
            <div class="p-2 bg-light/5 rounded border border-light/10">
              <p class="font-bold">三条</p>
              <p class="text-sm text-light/70">三张相同点数的牌 - 300分</p>
            </div>
            <div class="p-2 bg-light/5 rounded border border-light/10">
              <p class="font-bold">顺子</p>
              <p class="text-sm text-light/70">五张点数连续的牌 - 500分</p>
            </div>
            <div class="p-2 bg-light/5 rounded border border-light/10">
              <p class="font-bold">同花</p>
              <p class="text-sm text-light/70">所有牌花色相同 - 600分</p>
            </div>
            <div class="p-2 bg-light/5 rounded border border-light/10">
              <p class="font-bold">同花顺</p>
              <p class="text-sm text-light/70">点数连续且花色相同 - 1000分</p>
            </div>
          </div>
        </div>
        
        <!-- 道具栏 -->
        <div class="bg-dark/50 rounded-lg border border-light/10 p-5">
          <h2 class="text-xl font-bold mb-4 text-secondary">你的道具</h2>
          <div id="inventory" class="space-y-2 max-h-40 overflow-y-auto pr-2">
            <p class="text-light/70">暂无道具</p>
          </div>
        </div>
      </div>
      
      <!-- 中间：主游戏区 -->
      <div class="lg:col-span-2 flex flex-col gap-6">
        <!-- 出牌区 -->
        <div class="bg-dark/50 rounded-lg border border-light/10 p-5 min-h-[180px]" id="play-area-container">
          <h2 class="text-xl font-bold mb-4 text-secondary">出牌区</h2>
          <div id="play-area" class="flex flex-wrap gap-3 justify-center min-h-[120px]">
            <p class="text-light/50 italic">将卡牌拖到此处组成你的手牌</p>
          </div>
        </div>
        
        <!-- 手牌区 -->
        <div class="bg-dark/50 rounded-lg border border-light/10 p-5" id="hand-area-container">
          <h2 class="text-xl font-bold mb-4 text-secondary">你的卡牌</h2>
          <div id="hand-area" class="flex flex-wrap gap-3 justify-center min-h-[120px]">
            <!-- 卡牌将通过JS动态生成 -->
            <p class="text-light/50 italic">点击"抽牌"获取你的卡牌</p>
          </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="flex justify-center gap-4">
          <button id="draw-btn" class="px-6 py-3 bg-accent hover:bg-accent/80 rounded-lg transition-all font-bold text-lg animate-shine">
            抽牌
          </button>
          <button id="score-btn" class="px-6 py-3 bg-secondary hover:bg-secondary/80 rounded-lg transition-all font-bold text-lg" disabled>
            计算得分
          </button>
        </div>
      </div>
    </div>
    
    <!-- 游戏结束模态框 -->
    <div id="game-over-modal" class="fixed inset-0 bg-dark/80 flex items-center justify-center z-50 hidden">
      <div class="bg-dark border-2 border-accent rounded-lg p-8 max-w-md w-full mx-4 text-center">
        <h2 class="text-3xl font-game text-accent mb-4">游戏结束</h2>
        <p class="text-xl mb-2">你的最终得分</p>
        <p class="text-4xl font-bold text-light mb-6" id="final-score">0</p>
        <button id="play-again-btn" class="px-6 py-3 bg-accent hover:bg-accent/80 rounded-lg transition-all font-bold text-lg w-full">
          再玩一次
        </button>
      </div>
    </div>
    
    <!-- 帮助模态框 -->
    <div id="help-modal" class="fixed inset-0 bg-dark/80 flex items-center justify-center z-50 hidden">
      <div class="bg-dark border-2 border-accent rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
        <h2 class="text-2xl font-game text-accent mb-4">游戏说明</h2>
        <div class="space-y-4 text-light/90">
          <p>1. 点击"抽牌"从牌堆获取5张牌</p>
          <p>2. 从手牌区拖动卡牌到出牌区组成你的手牌</p>
          <p>3. 组成卡牌组合获得分数</p>
          <p>4. 点击"计算得分"统计你的分数并开始新回合</p>
          <p>5. 每回合结束后可进入商店购买道具</p>
          <p>6. 当牌堆用尽时游戏结束</p>
          
          <h3 class="text-xl text-secondary mt-6 mb-2">组合分值</h3>
          <ul class="list-disc pl-5 space-y-1">
            <li>一对 - 100分</li>
            <li>两对 - 250分</li>
            <li>三条 - 300分</li>
            <li>顺子 - 500分</li>
            <li>同花 - 600分</li>
            <li>葫芦 - 800分</li>
            <li>四条 - 900分</li>
            <li>同花顺 - 1000分</li>
            <li>皇家同花顺 - 2000分</li>
          </ul>
        </div>
        <button id="close-help-btn" class="mt-6 px-6 py-2 bg-accent hover:bg-accent/80 rounded-lg transition-all font-bold">
          关闭
        </button>
      </div>
    </div>
    
    <!-- 商店模态框 -->
    <div id="shop-modal" class="fixed inset-0 bg-dark/80 flex items-center justify-center z-50 hidden">
      <div class="bg-dark border-2 border-accent rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
        <h2 class="text-2xl font-game text-accent mb-6 text-center">道具商店</h2>
        <p class="text-center mb-6">当前积分: <span id="shop-score" class="text-accent font-bold">0</span></p>
        
        <div id="shop-items" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- 商店物品将通过JS动态生成 -->
        </div>
        
        <div class="mt-8 text-center">
          <button id="close-shop-btn" class="px-6 py-3 bg-secondary hover:bg-secondary/80 rounded-lg transition-all font-bold">
            结束购物
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 游戏状态
    const gameState = {
      deck: [],
      hand: [],
      playArea: [],
      score: 0,
      round: 1,
      cardsLeft: 52,
      gameOver: false,
      draggedCardId: null,
      inventory: [], // 道具栏
      activeEffects: {} // 当前生效的效果
    };
    
    // 道具配置
    const shopItems = [
      {
        id: 'extra_card',
        name: '额外卡牌',
        description: '本回合可获得6张手牌而非5张',
        cost: 150,
        icon: 'fa-plus-square'
      },
      {
        id: 'score_boost',
        name: '分数增幅',
        description: '本回合得分增加20%',
        cost: 200,
        icon: 'fa-percent'
      },
      {
        id: 'card_replace',
        name: '卡牌替换',
        description: '本回合可替换2张不满意的卡牌',
        cost: 100,
        icon: 'fa-exchange'
      },
      {
        id: 'flush_bonus',
        name: '同花加成',
        description: '同花组合得分翻倍',
        cost: 300,
        icon: 'fa-diamond'
      },
      {
        id: 'straight_bonus',
        name: '顺子加成',
        description: '顺子组合得分翻倍',
        cost: 300,
        icon: 'fa-arrows-h'
      },
      {
        id: 'royal_bonus',
        name: '皇家幸运',
        description: '皇家同花顺概率小幅提升',
        cost: 500,
        icon: 'fa-star'
      }
    ];
    
    // 卡牌配置
    const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
    const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
    const rankValues = {
      '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10,
      'J': 11, 'Q': 12, 'K': 13, 'A': 14
    };
    
    // DOM元素
    const handArea = document.getElementById('hand-area');
    const playArea = document.getElementById('play-area');
    const handAreaContainer = document.getElementById('hand-area-container');
    const playAreaContainer = document.getElementById('play-area-container');
    const scoreDisplay = document.getElementById('score');
    const roundDisplay = document.getElementById('round');
    const cardsLeftDisplay = document.getElementById('cards-left');
    const drawBtn = document.getElementById('draw-btn');
    const scoreBtn = document.getElementById('score-btn');
    const restartBtn = document.getElementById('restart-btn');
    const handInfo = document.getElementById('hand-info');
    const gameOverModal = document.getElementById('game-over-modal');
    const finalScoreDisplay = document.getElementById('final-score');
    const playAgainBtn = document.getElementById('play-again-btn');
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('help-modal');
    const closeHelpBtn = document.getElementById('close-help-btn');
    const shopModal = document.getElementById('shop-modal');
    const shopScoreDisplay = document.getElementById('shop-score');
    const shopItemsContainer = document.getElementById('shop-items');
    const closeShopBtn = document.getElementById('close-shop-btn');
    const inventoryContainer = document.getElementById('inventory');
    
    // 初始化游戏
    function initGame() {
      // 重置游戏状态
      gameState.deck = createDeck();
      gameState.hand = [];
      gameState.playArea = [];
      gameState.score = 0;
      gameState.round = 1;
      gameState.cardsLeft = 52;
      gameState.gameOver = false;
      gameState.draggedCardId = null;
      gameState.inventory = [];
      gameState.activeEffects = {};
      
      // 更新UI
      updateScore();
      updateRound();
      updateCardsLeft();
      renderHand();
      renderPlayArea();
      updateHandInfo();
      renderInventory();
      
      // 禁用按钮
      scoreBtn.disabled = true;
      gameOverModal.classList.add('hidden');
      shopModal.classList.add('hidden');
    }
    
    // 创建一副新牌
    function createDeck() {
      const deck = [];
      for (const suit of suits) {
        for (const rank of ranks) {
          deck.push({
            id: `${suit}-${rank}`,
            suit,
            rank,
            value: rankValues[rank]
          });
        }
      }
      // 洗牌
      return shuffleDeck(deck);
    }
    
    // 洗牌算法
    function shuffleDeck(deck) {
      // 如果有皇家幸运效果，增加高牌概率
      if (gameState.activeEffects.royal_bonus) {
        // 复制高牌（10到A）增加概率
        const highCards = deck.filter(card => 
          ['10', 'J', 'Q', 'K', 'A'].includes(card.rank)
        );
        deck = [...deck, ...highCards.slice(0, 5)];
      }
      
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      return deck;
    }
    
    // 抽牌
    function drawCards() {
      // 确定抽牌数量（默认5张，有额外卡牌道具则6张）
      const count = gameState.activeEffects.extra_card ? 6 : 5;
      
      if (gameState.deck.length < count) {
        endGame();
        return;
      }
      
      // 清空当前手牌和出牌区
      gameState.hand = [];
      gameState.playArea = [];
      
      // 抽牌
      for (let i = 0; i < count; i++) {
        const card = gameState.deck.pop();
        gameState.hand.push(card);
        gameState.cardsLeft--;
      }
      
      // 更新UI
      renderHand();
      renderPlayArea();
      updateCardsLeft();
      updateHandInfo();
      
      // 禁用抽牌按钮，启用计分按钮
      drawBtn.disabled = true;
      scoreBtn.disabled = false;
      
      // 如果有卡牌替换道具，显示替换按钮
      if (gameState.activeEffects.card_replace) {
        addReplaceButtons();
      }
    }
    
    // 添加卡牌替换按钮
    function addReplaceButtons() {
      const replaceContainer = document.createElement('div');
      replaceContainer.id = 'replace-container';
      replaceContainer.className = 'mt-4 text-center';
      
      const replaceBtn1 = document.createElement('button');
      replaceBtn1.className = 'px-4 py-2 bg-primary hover:bg-primary/80 rounded-lg transition-all mr-2';
      replaceBtn1.innerHTML = '<i class="fa fa-refresh mr-1"></i> 替换1张牌';
      replaceBtn1.addEventListener('click', () => replaceCards(1));
      
      const replaceBtn2 = document.createElement('button');
      replaceBtn2.className = 'px-4 py-2 bg-primary hover:bg-primary/80 rounded-lg transition-all';
      replaceBtn2.innerHTML = '<i class="fa fa-refresh mr-1"></i> 替换2张牌';
      replaceBtn2.addEventListener('click', () => replaceCards(2));
      
      replaceContainer.appendChild(replaceBtn1);
      replaceContainer.appendChild(replaceBtn2);
      handAreaContainer.parentNode.appendChild(replaceContainer);
    }
    
    // 替换卡牌
    function replaceCards(count) {
      if (gameState.deck.length < count) {
        alert('牌堆中没有足够的牌进行替换');
        return;
      }
      
      // 移除最前面的n张牌并替换
      for (let i = 0; i < count; i++) {
        gameState.hand.shift();
        const newCard = gameState.deck.pop();
        gameState.hand.push(newCard);
        gameState.cardsLeft--;
      }
      
      // 重新渲染手牌
      renderHand();
      
      // 移除替换按钮
      const replaceContainer = document.getElementById('replace-container');
      if (replaceContainer) {
        replaceContainer.remove();
      }
      
      // 禁用卡牌替换效果
      gameState.activeEffects.card_replace = false;
    }
    
    // 计算手牌分数
    function calculateScore() {
      if (gameState.playArea.length === 0) return 0;
      
      // 分析手牌
      let combo = analyzeHand(gameState.playArea);
      let score = combo.score;
      
      // 应用分数增幅效果
      if (gameState.activeEffects.score_boost) {
        score = Math.round(score * 1.2);
      }
      
      // 应用同花加成效果
      if (gameState.activeEffects.flush_bonus && combo.type === '同花') {
        score *= 2;
      }
      
      // 应用顺子加成效果
      if (gameState.activeEffects.straight_bonus && combo.type === '顺子') {
        score *= 2;
      }
      
      // 更新组合信息（包含加成）
      const displayedCombo = {
        ...combo,
        score: score
      };
      
      updateHandInfo(displayedCombo);
      
      // 添加分数
      gameState.score += score;
      updateScore();
      
      // 移除替换按钮（如果存在）
      const replaceContainer = document.getElementById('replace-container');
      if (replaceContainer) {
        replaceContainer.remove();
      }
      
      // 准备进入下一轮
      prepareNextRound();
      
      return score;
    }
    
    // 准备下一轮
    function prepareNextRound() {
      // 清空当前效果
      gameState.activeEffects = {};
      
      // 进入下一轮
      gameState.round++;
      updateRound();
      
      // 显示商店
      showShop();
    }
    
    // 显示商店
    function showShop() {
      // 更新商店中的分数显示
      shopScoreDisplay.textContent = gameState.score;
      
      // 渲染商店物品
      renderShopItems();
      
      // 显示商店模态框
      shopModal.classList.remove('hidden');
    }
    
    // 渲染商店物品
    function renderShopItems() {
      shopItemsContainer.innerHTML = '';
      
      shopItems.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'p-4 bg-light/5 rounded border border-light/10 item-hover flex justify-between items-center';
        
        itemElement.innerHTML = `
          <div>
            <div class="flex items-center">
              <i class="fa ${item.icon} text-accent mr-2"></i>
              <h3 class="font-bold">${item.name}</h3>
            </div>
            <p class="text-sm text-light/70 mt-1">${item.description}</p>
          </div>
          <div class="text-right">
            <p class="text-accent font-bold">${item.cost} 分</p>
            <button class="buy-btn mt-2 px-3 py-1 bg-accent hover:bg-accent/80 rounded text-sm font-bold" 
                    data-item-id="${item.id}" 
                    ${gameState.score < item.cost ? 'disabled' : ''}>
              购买
            </button>
          </div>
        `;
        
        shopItemsContainer.appendChild(itemElement);
      });
      
      // 添加购买事件监听
      document.querySelectorAll('.buy-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const itemId = e.currentTarget.dataset.itemId;
          buyItem(itemId);
        });
      });
    }
    
    // 购买物品
    function buyItem(itemId) {
      const item = shopItems.find(i => i.id === itemId);
      
      if (!item) return;
      if (gameState.score < item.cost) return;
      
      // 扣除分数
      gameState.score -= item.cost;
      updateScore();
      shopScoreDisplay.textContent = gameState.score;
      
      // 将物品添加到库存或立即生效
      gameState.activeEffects[itemId] = true;
      
      // 更新库存显示
      renderInventory();
      
      // 重新渲染商店（更新购买按钮状态）
      renderShopItems();
      
      // 显示购买成功提示
      alert(`成功购买: ${item.name}`);
    }
    
    // 渲染库存
    function renderInventory() {
      inventoryContainer.innerHTML = '';
      
      const activeItems = Object.entries(gameState.activeEffects)
        .filter(([_, active]) => active)
        .map(([id, _]) => shopItems.find(item => item.id === id));
      
      if (activeItems.length === 0) {
        inventoryContainer.innerHTML = '<p class="text-light/70">暂无道具</p>';
        return;
      }
      
      activeItems.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'p-2 bg-light/5 rounded border border-light/10 flex items-center';
        itemElement.innerHTML = `
          <i class="fa ${item.icon} text-accent mr-2"></i>
          <div>
            <p class="font-bold text-sm">${item.name}</p>
            <p class="text-xs text-light/70">${item.description}</p>
          </div>
        `;
        inventoryContainer.appendChild(itemElement);
      });
    }
    
    // 分析手牌组合
    function analyzeHand(hand) {
      if (hand.length < 2) {
        return { type: '无组合', score: 0 };
      }
      
      // 按点数排序
      const sortedHand = [...hand].sort((a, b) => a.value - b.value);
      
      // 检查皇家同花顺
      if (isRoyalFlush(sortedHand)) {
        return { type: '皇家同花顺', score: 2000 };
      }
      
      // 检查同花顺
      if (isStraightFlush(sortedHand)) {
        return { type: '同花顺', score: 1000 };
      }
      
      // 检查四条
      if (isFourOfAKind(sortedHand)) {
        return { type: '四条', score: 900 };
      }
      
      // 检查葫芦
      if (isFullHouse(sortedHand)) {
        return { type: '葫芦', score: 800 };
      }
      
      // 检查同花
      if (isFlush(sortedHand)) {
        return { type: '同花', score: 600 };
      }
      
      // 检查顺子
      if (isStraight(sortedHand)) {
        return { type: '顺子', score: 500 };
      }
      
      // 检查三条
      if (isThreeOfAKind(sortedHand)) {
        return { type: '三条', score: 300 };
      }
      
      // 检查两对
      if (isTwoPairs(sortedHand)) {
        return { type: '两对', score: 250 };
      }
      
      // 检查一对
      if (isPair(sortedHand)) {
        return { type: '一对', score: 100 };
      }
      
      return { type: '高牌', score: 0 };
    }
    
    // 组合检查函数
    function isRoyalFlush(hand) {
      if (hand.length !== 5) return false;
      if (!isFlush(hand)) return false;
      
      const ranks = hand.map(card => card.rank);
      return ranks.includes('10') && ranks.includes('J') && 
             ranks.includes('Q') && ranks.includes('K') && ranks.includes('A');
    }
    
    function isStraightFlush(hand) {
      return hand.length === 5 && isStraight(hand) && isFlush(hand);
    }
    
    function isFourOfAKind(hand) {
      const rankCounts = getRankCounts(hand);
      return Object.values(rankCounts).includes(4);
    }
    
    function isFullHouse(hand) {
      const rankCounts = getRankCounts(hand);
      const counts = Object.values(rankCounts);
      return counts.includes(3) && counts.includes(2);
    }
    
    function isFlush(hand) {
      const suit = hand[0].suit;
      return hand.every(card => card.suit === suit);
    }
    
    function isStraight(hand) {
      if (hand.length !== 5) return false;
      
      // 检查A-2-3-4-5的特殊情况
      const isLowStraight = hand[0].value === 2 && hand[1].value === 3 && 
                           hand[2].value === 4 && hand[3].value === 5 && 
                           hand[4].value === 14; // Ace
      if (isLowStraight) return true;
      
      // 检查正常顺子
      for (let i = 0; i < hand.length - 1; i++) {
        if (hand[i + 1].value - hand[i].value !== 1) {
          return false;
        }
      }
      return true;
    }
    
    function isThreeOfAKind(hand) {
      const rankCounts = getRankCounts(hand);
      return Object.values(rankCounts).includes(3);
    }
    
    function isTwoPairs(hand) {
      const rankCounts = getRankCounts(hand);
      const pairs = Object.values(rankCounts).filter(count => count === 2);
      return pairs.length === 2;
    }
    
    function isPair(hand) {
      const rankCounts = getRankCounts(hand);
      return Object.values(rankCounts).includes(2);
    }
    
    // 获取每个点数的出现次数
    function getRankCounts(hand) {
      const counts = {};
      for (const card of hand) {
        counts[card.rank] = (counts[card.rank] || 0) + 1;
      }
      return counts;
    }
    
    // 渲染手牌
    function renderHand() {
      handArea.innerHTML = '';
      
      if (gameState.hand.length === 0) {
        handArea.innerHTML = '<p class="text-light/50 italic">点击"抽牌"获取你的卡牌</p>';
        return;
      }
      
      for (const card of gameState.hand) {
        const cardElement = createCardElement(card, true);
        handArea.appendChild(cardElement);
      }
    }
    
    // 渲染出牌区
    function renderPlayArea() {
      playArea.innerHTML = '';
      
      if (gameState.playArea.length === 0) {
        playArea.innerHTML = '<p class="text-light/50 italic">将卡牌拖到此处组成你的手牌</p>';
        return;
      }
      
      for (const card of gameState.playArea) {
        const cardElement = createCardElement(card, false);
        playArea.appendChild(cardElement);
      }
    }
    
    // 创建卡牌元素
    function createCardElement(card, isInHand) {
      const cardElement = document.createElement('div');
      cardElement.className = `w-20 h-30 rounded-lg card-shadow card-hover animate-deal cursor-move relative`;
      
      // 根据花色设置颜色
      const isRed = card.suit === 'hearts' || card.suit === 'diamonds';
      cardElement.classList.add(isRed ? 'bg-red-100' : 'bg-gray-100');
      cardElement.classList.add(isRed ? 'text-red-600' : 'text-gray-800');
      
      // 设置卡牌内容
      cardElement.innerHTML = `
        <div class="absolute top-2 left-2 text-lg font-bold">${card.rank}</div>
        <div class="absolute top-2 right-2 text-xl">${getSuitSymbol(card.suit)}</div>
        <div class="absolute bottom-2 right-2 text-lg font-bold transform rotate-180">${card.rank}</div>
        <div class="absolute bottom-2 left-2 text-xl transform rotate-180">${getSuitSymbol(card.suit)}</div>
      `;
      
      // 设置拖拽功能
      cardElement.setAttribute('draggable', 'true');
      cardElement.dataset.cardId = card.id;
      
      // 拖拽开始
      cardElement.addEventListener('dragstart', (e) => {
        gameState.draggedCardId = card.id;
        // 添加拖拽视觉效果
        cardElement.classList.add('opacity-50');
        // 设置拖拽图像
        e.dataTransfer.setData('text/plain', card.id);
        // 创建自定义拖拽图像
        const dragImage = cardElement.cloneNode(true);
        dragImage.style.position = 'absolute';
        dragImage.style.top = '-1000px';
        document.body.appendChild(dragImage);
        e.dataTransfer.setDragImage(dragImage, 20, 30);
        
        // 延迟移除克隆元素
        setTimeout(() => {
          document.body.removeChild(dragImage);
        }, 0);
      });
      
      // 拖拽结束
      cardElement.addEventListener('dragend', () => {
        cardElement.classList.remove('opacity-50');
        gameState.draggedCardId = null;
        // 移除所有拖放区域的高亮
        playAreaContainer.classList.remove('drag-over');
        handAreaContainer.classList.remove('drag-over');
      });
      
      // 如果卡牌在出牌区，添加点击移除功能
      if (!isInHand) {
        cardElement.addEventListener('click', () => {
          removeFromPlayArea(card.id);
        });
      }
      
      return cardElement;
    }
    
    // 获取花色符号
    function getSuitSymbol(suit) {
      switch(suit) {
        case 'hearts': return '♥';
        case 'diamonds': return '♦';
        case 'clubs': return '♣';
        case 'spades': return '♠';
        default: return '';
      }
    }
    
    // 添加到出牌区
    function addToPlayArea(cardId) {
      // 从手牌中找到卡牌
      const cardIndex = gameState.hand.findIndex(card => card.id === cardId);
      if (cardIndex === -1) return;
      
      const card = gameState.hand.splice(cardIndex, 1)[0];
      
      // 添加到出牌区
      gameState.playArea.push(card);
      
      // 更新UI
      renderHand();
      renderPlayArea();
      updateHandInfo();
      
      // 如果出牌区有卡牌，启用计分按钮
      scoreBtn.disabled = gameState.playArea.length === 0;
    }
    
    // 从出牌区移除
    function removeFromPlayArea(cardId) {
      // 从出牌区找到卡牌
      const cardIndex = gameState.playArea.findIndex(card => card.id === cardId);
      if (cardIndex === -1) return;
      
      const card = gameState.playArea.splice(cardIndex, 1)[0];
      
      // 添加到手牌
      gameState.hand.push(card);
      
      // 更新UI
      renderHand();
      renderPlayArea();
      updateHandInfo();
      
      // 如果出牌区没有卡牌，禁用计分按钮
      if (gameState.playArea.length === 0) {
        scoreBtn.disabled = true;
      }
    }
    
    // 更新手牌信息
    function updateHandInfo(combo = null) {
      handInfo.innerHTML = '';
      
      if (gameState.playArea.length === 0) {
        handInfo.innerHTML = '<p class="text-light/70">未选择卡牌</p>';
        return;
      }
      
      // 显示选中的卡牌
      const cardsList = document.createElement('div');
      cardsList.className = 'mb-3';
      cardsList.innerHTML = `<p class="font-bold">已选卡牌: ${gameState.playArea.length}</p>`;
      handInfo.appendChild(cardsList);
      
      // 显示组合信息
      if (combo) {
        const comboInfo = document.createElement('div');
        comboInfo.className = 'p-2 bg-accent/20 rounded border border-accent/30';
        comboInfo.innerHTML = `
          <p class="font-bold text-accent">${combo.type}</p>
          <p class="text-light/80">+${combo.score} 分</p>
        `;
        handInfo.appendChild(comboInfo);
      } else {
        const currentCombo = analyzeHand(gameState.playArea);
        if (currentCombo.score > 0) {
          const comboInfo = document.createElement('div');
          comboInfo.className = 'p-2 bg-light/5 rounded border border-light/10';
          comboInfo.innerHTML = `
            <p class="font-bold">${currentCombo.type}</p>
            <p class="text-light/70">${currentCombo.score} 分</p>
          `;
          handInfo.appendChild(comboInfo);
        } else {
          handInfo.innerHTML += '<p class="text-light/70">无有效组合</p>';
        }
      }
    }
    
    // 更新分数显示
    function updateScore() {
      scoreDisplay.textContent = gameState.score;
      finalScoreDisplay.textContent = gameState.score;
    }
    
    // 更新回合显示
    function updateRound() {
      roundDisplay.textContent = gameState.round;
    }
    
    // 更新剩余卡牌显示
    function updateCardsLeft() {
      cardsLeftDisplay.textContent = gameState.cardsLeft;
    }
    
    // 结束游戏
    function endGame() {
      gameState.gameOver = true;
      gameOverModal.classList.remove('hidden');
    }
    
    // 初始化拖拽区域事件
    function initDragDropEvents() {
      // 出牌区拖拽目标
      playAreaContainer.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        playAreaContainer.classList.add('drag-over');
      });
      
      playAreaContainer.addEventListener('dragleave', () => {
        playAreaContainer.classList.remove('drag-over');
      });
      
      playAreaContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        playAreaContainer.classList.remove('drag-over');
        const cardId = e.dataTransfer.getData('text/plain') || gameState.draggedCardId;
        if (cardId) {
          addToPlayArea(cardId);
        }
      });
      
      // 手牌区拖拽目标
      handAreaContainer.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        handAreaContainer.classList.add('drag-over');
      });
      
      handAreaContainer.addEventListener('dragleave', () => {
        handAreaContainer.classList.remove('drag-over');
      });
      
      handAreaContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        handAreaContainer.classList.remove('drag-over');
        const cardId = e.dataTransfer.getData('text/plain') || gameState.draggedCardId;
        if (cardId) {
          removeFromPlayArea(cardId);
        }
      });
    }
    
    // 事件监听
    drawBtn.addEventListener('click', () => {
      drawCards();
    });
    
    scoreBtn.addEventListener('click', () => {
      calculateScore();
    });
    
    restartBtn.addEventListener('click', initGame);
    playAgainBtn.addEventListener('click', initGame);
    
    // 帮助模态框
    helpBtn.addEventListener('click', () => {
      helpModal.classList.remove('hidden');
    });
    
    closeHelpBtn.addEventListener('click', () => {
      helpModal.classList.add('hidden');
    });
    
    // 商店模态框
    closeShopBtn.addEventListener('click', () => {
      shopModal.classList.add('hidden');
      // 重新启用抽牌按钮
      drawBtn.disabled = false;
    });
    
    // 初始化拖拽事件
    initDragDropEvents();
    
    // 初始化游戏
    window.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>
